<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hotel Bicycle Management System</title>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>

    <style>
        /* Base Styles */
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            background-color: #f5f6fa;
        }

        .header {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        /* Previous CSS styles remain the same */
        /* ... (Keep all your existing CSS) ... */
    </style>
</head>
<body>
    <div class="header">
        <h1>Hotel Bicycle Management System</h1>
        <!-- Added status indicator -->
        <div id="connectionStatus" style="font-size: 12px; color: green;"></div>
    </div>

    <!-- Today's Departures Section -->
    <div id="todayDepartures" class="departure-notice" style="display: none;">
        <h3>Today's Departures:</h3>
        <div id="departuresList"></div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-container no-print">
        <div class="tab-buttons">
            <button class="tab-button active" onclick="showTab('issuing')">Bicycle Issuing</button>
            <button class="tab-button" onclick="showTab('faulty')">Faulty Bicycles</button>
            <button class="tab-button" onclick="showTab('arrival')">Arrival Preparation</button>
        </div>
    </div>
<!-- Bicycle Issuing Tab -->
    <div id="issuingTab" class="tab-content active">
        <div class="search-section no-print">
            <div class="search-group">
                <input type="text" id="bicycleSearch" placeholder="Search by Bicycle Number...">
                <button onclick="searchByBicycle()">Search Bicycle</button>
            </div>
            <div class="search-group">
                <input type="text" id="roomSearch" placeholder="Search by Room Number...">
                <button onclick="searchByRoom()">Search Room</button>
            </div>
            <div class="search-group">
                <button onclick="resetSearch()">Reset Search</button>
                <button class="print-btn" onclick="printDepartures()">Print Today's Departures</button>
                <button class="print-btn" onclick="printRecords()">Print Records</button>
            </div>
        </div>

        <form id="bicycleForm" class="form-section no-print">
            <h2>Issue Bicycle</h2>
            <input type="hidden" id="editIndex">
            
            <div class="form-grid">
                
                <!-- Existing form fields -->
    
    <div>
        <label for="arrivalDocument">Arrival Document (PDF):</label>
        <input type="file" id="arrivalDocument" accept=".pdf" 
               onchange="handlePDFUpload(event)">
    </div>

    <div>
        <label>Auto-generate Room Numbers:</label>
        <button type="button" onclick="generateRoomNumbers()" 
                class="generate-btn">Generate</button>
    </div>
</div>
                <div>
                    <label for="roomNumber">Room Number:</label>
                    <input type="text" id="roomNumber" required>
                </div>
                
                <div>
                    <label for="guestName">Guest Name:</label>
                    <input type="text" id="guestName" required>
                </div>
                
                <div>
                    <label for="issueDate">Date of Issue:</label>
                    <input type="date" id="issueDate" required>
                </div>
                
                <div>
                    <label for="departureDate">Date of Departure:</label>
                    <input type="date" id="departureDate" required>
                </div>
                
                <div>
                    <label for="bicycleNumber">Bicycle Number:</label>
                    <input type="text" id="bicycleNumber" required pattern="^(K-\d{2}|[1-9]\d{0,2})$" 
                           title="Enter valid bicycle number (1-400 or K-01 to K-99)">
                </div>
            </div>
            
            <button type="submit">Save Record</button>
        </form>

        <table id="recordsTable">
            <thead>
                <tr>
                    <th>Room Number</th>
                    <th>Guest Name</th>
                    <th>Issue Date</th>
                    <th>Departure Date</th>
                    <th>Bicycle Number</th>
                    <th>Status</th>
                    <th class="no-print">Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Notification div -->
    <div id="notification" class="notification"></div>

    <!-- Loading indicator -->
    <div id="loadingIndicator" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255,255,255,0.9); padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        Loading...
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBjAGc8L0bkO_2RbWi0-rw7__lSHCoBrJQ",
            authDomain: "bicycle-issuing-system2.firebaseapp.com",
            projectId: "bicycle-issuing-system2",
            storageBucket: "bicycle-issuing-system2.firebasestorage.app",
            messagingSenderId: "64926990610",
            appId: "1:64926990610:web:f45390888ea1d0dfb5f3cb"
        };

        // Initialize Firebase with error handling
        try {
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            console.log('Firebase initialized successfully');
            document.getElementById('connectionStatus').textContent = 'Connected to database';
        } catch (error) {
            console.error('Error initializing Firebase:', error);
            document.getElementById('connectionStatus').textContent = 'Error connecting to database';
            document.getElementById('connectionStatus').style.color = 'red';
        }

        // Global variables
        let records = [];
        let isLoading = false;

        // Show/Hide Loading Indicator
        function toggleLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
            isLoading = show;
        }
          // Record Management Functions
        function loadRecords() {
            toggleLoading(true);
            console.log('Loading records...');
            
            db.collection('bicycleRecords')
                .orderBy('timestamp', 'desc')
                .get()
                .then((snapshot) => {
                    records = [];
                    snapshot.forEach((doc) => {
                        records.push({ id: doc.id, ...doc.data() });
                    });
                    console.log(`Loaded ${records.length} records`);
                    displayRecords();
                    checkDepartures();
                })
                .catch((error) => {
                    console.error("Error loading records:", error);
                    showNotification('Error loading records', 'error');
                })
                .finally(() => {
                    toggleLoading(false);
                });
        }

        // Display Records
        function displayRecords(recordsToShow = records) {
            const table = document.getElementById('recordsTable').getElementsByTagName('tbody')[0];
            table.innerHTML = '';
            recordsToShow.forEach((record, index) => {
                const row = table.insertRow();
                const statusClass = record.status === 'Returned' ? 'status-returned' : '';
                row.innerHTML = `
                    <td>${record.roomNumber}</td>
                    <td>${record.guestName}</td>
                    <td>${formatDate(record.issueDate)}</td>
                    <td>${formatDate(record.departureDate)}</td>
                    <td>${record.bicycleNumber}</td>
                    <td class="${statusClass}">${record.status || 'Active'}</td>
                    <td class="no-print">
                        ${record.status !== 'Returned' ? `
                            <button class="edit-btn" onclick="editRecord(${index})">Edit</button>
                            <button class="return-btn" onclick="markAsReturned('${record.id}')">Return</button>
                            <button class="delete-btn" onclick="deleteRecord('${record.id}')">Delete</button>
                        ` : ''}
                    </td>
                `;
            });
        }
// Initialize Firebase Storage
const storage = firebase.storage();

// Handle PDF Upload
async function handlePDFUpload(event) {
    const file = event.target.files[0];
    if (file && file.type === 'application/pdf') {
        try {
            toggleLoading(true);
            const storageRef = storage.ref();
            const fileRef = storageRef.child(`arrival_docs/${Date.now()}_${file.name}`);
            await fileRef.put(file);
            const downloadURL = await fileRef.getDownloadURL();
            
            // Store the URL in a hidden input
            document.getElementById('pdfURL').value = downloadURL;
            showNotification('PDF uploaded successfully');
        } catch (error) {
            console.error('Error uploading PDF:', error);
            showNotification('Error uploading PDF', 'error');
        } finally {
            toggleLoading(false);
        }
    } else {
        showNotification('Please select a PDF file', 'error');
    }
}

// Generate Room Numbers
function generateRoomNumbers() {
    // Get arrival date
    const arrivalDate = document.getElementById('arrivalDate').value;
    if (!arrivalDate) {
        showNotification('Please select arrival date first', 'error');
        return;
    }

    // Format date for display
    const formattedDate = new Date(arrivalDate).toLocaleDateString();

    // Create modal for room generation
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content">
            <h3>Generate Room Numbers for ${formattedDate}</h3>
            <div class="room-generation-form">
                <div class="form-group">
                    <label>Floor Selection:</label>
                    <select id="floorSelect">
                        <option value="1">1st Floor (101-120)</option>
                        <option value="2">2nd Floor (201-220)</option>
                        <option value="3">3rd Floor (301-320)</option>
                        <option value="4">4th Floor (401-420)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Number of Rooms Needed:</label>
                    <input type="number" id="roomCount" min="1" max="20" value="1">
                </div>
                <div class="buttons">
                    <button onclick="confirmRoomGeneration()" class="generate-btn">Generate</button>
                    <button onclick="closeModal()" class="cancel-btn">Cancel</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function confirmRoomGeneration() {
    const floor = document.getElementById('floorSelect').value;
    const count = parseInt(document.getElementById('roomCount').value);
    
    // Generate available room numbers
    const availableRooms = generateAvailableRooms(floor, count);
    
    if (availableRooms.length < count) {
        showNotification('Not enough available rooms on selected floor', 'error');
        return;
    }

    // Update the room number input
    document.getElementById('roomNumber').value = availableRooms[0];
    
    // Create arrival list
    createArrivalList(availableRooms);
    
    closeModal();
}

function generateAvailableRooms(floor, count) {
    const baseNumber = floor * 100;
    const allRooms = Array.from({length: 20}, (_, i) => baseNumber + i + 1);
    
    // Filter out already assigned rooms
    const assignedRooms = records
        .filter(r => r.status === 'Active')
        .map(r => parseInt(r.roomNumber));
    
    return allRooms
        .filter(room => !assignedRooms.includes(room))
        .slice(0, count);
}

function createArrivalList(rooms) {
    const arrivalDate = document.getElementById('arrivalDate').value;
    const formattedDate = new Date(arrivalDate).toLocaleDateString();

    // Create arrival list table
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Arrival List - ${formattedDate}</title>
            <style>
                body { font-family: Arial; padding: 20px; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background-color: #f5f5f5; }
                .header { margin-bottom: 20px; }
                @media print {
                    .no-print { display: none; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h2>Arrival List for ${formattedDate}</h2>
                <p>Total Rooms: ${rooms.length}</p>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Room Number</th>
                        <th>Guest Name</th>
                        <th>Bicycle Required</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    ${rooms.map(room => `
                        <tr>
                            <td>${room}</td>
                            <td></td>
                            <td>□ Yes  □ No</td>
                            <td></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            <div class="no-print" style="margin-top: 20px;">
                <button onclick="window.print()">Print List</button>
            </div>
        </body>
        </html>
    `);
    printWindow.document.close();
}

// Add this CSS for the modal
const style = document.createElement('style');
style.textContent = `
    .modal {
        display: block;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        z-index: 1000;
    }

    .modal-content {
        background-color: white;
        margin: 15% auto;
        padding: 20px;
        border-radius: 8px;
        width: 80%;
        max-width: 500px;
    }

    .room-generation-form {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }

    .generate-btn {
        background-color: #4CAF50;
    }

    .cancel-btn {
        background-color: #f44336;
    }
`;
document.head.appendChild(style);
        // Form Submission
        document.getElementById('bicycleForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            toggleLoading(true);
            console.log('Form submitted');

            try {
                const record = {
                    roomNumber: document.getElementById('roomNumber').value,
                    guestName: document.getElementById('guestName').value,
                    issueDate: document.getElementById('issueDate').value,
                    departureDate: document.getElementById('departureDate').value,
                    bicycleNumber: document.getElementById('bicycleNumber').value,
                    status: 'Active',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };

                console.log('Saving record:', record);

                const editIndex = document.getElementById('editIndex').value;
                
                if (editIndex !== '') {
                    // Update existing record
                    const docId = records[editIndex].id;
                    await db.collection('bicycleRecords').doc(docId).update(record);
                    console.log('Record updated successfully');
                    showNotification('Record updated successfully');
                } else {
                    // Add new record
                    const docRef = await db.collection('bicycleRecords').add(record);
                    console.log('New record added with ID:', docRef.id);
                    showNotification('Record saved successfully');
                }

                this.reset();
                document.getElementById('editIndex').value = '';
                document.getElementById('issueDate').valueAsDate = new Date();
                await loadRecords();

            } catch (error) {
                console.error('Error saving record:', error);
                showNotification('Error saving record: ' + error.message, 'error');
            } finally {
                toggleLoading(false);
            }
        });
// Save Arrival Preparation
async function saveArrivalPrep(event) {
    event.preventDefault();
    toggleLoading(true);

    try {
        const arrivalPrep = {
            roomNumber: document.getElementById('roomNumber').value,
            guestName: document.getElementById('arrivalGuest').value,
            arrivalDate: document.getElementById('arrivalDate').value,
            departureDate: document.getElementById('arrivalDeparture').value,
            bicycleRequired: document.getElementById('bicycleRequired').value,
            bikeType: document.getElementById('bikeType').value,
            notes: document.getElementById('arrivalNotes').value,
            pdfURL: document.getElementById('pdfURL').value || null,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        await db.collection('arrivalPrep').add(arrivalPrep);
        showNotification('Arrival preparation saved successfully');
        loadArrivalPrep();
        event.target.reset();
    } catch (error) {
        console.error('Error saving arrival prep:', error);
        showNotification('Error saving arrival preparation', 'error');
    } finally {
        toggleLoading(false);
    }
}

// Load Arrival Preparations
async function loadArrivalPrep() {
    toggleLoading(true);
    try {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        const tomorrowStr = tomorrow.toISOString().split('T')[0];

        const snapshot = await db.collection('arrivalPrep')
            .where('arrivalDate', '==', tomorrowStr)
            .get();

        const arrivals = [];
        snapshot.forEach(doc => {
            arrivals.push({ id: doc.id, ...doc.data() });
        });

        displayArrivalPrep(arrivals);
    } catch (error) {
        console.error('Error loading arrival preparations:', error);
        showNotification('Error loading arrival preparations', 'error');
    } finally {
        toggleLoading(false);
    }
}

        // Edit Record
        function editRecord(index) {
            const record = records[index];
            document.getElementById('roomNumber').value = record.roomNumber;
            document.getElementById('guestName').value = record.guestName;
            document.getElementById('issueDate').value = record.issueDate;
            document.getElementById('departureDate').value = record.departureDate;
            document.getElementById('bicycleNumber').value = record.bicycleNumber;
            document.getElementById('editIndex').value = index;
        }

        // Delete Record
        async function deleteRecord(id) {
            if (!confirm('Are you sure you want to delete this record?')) return;

            toggleLoading(true);
            try {
                await db.collection('bicycleRecords').doc(id).delete();
                console.log('Record deleted successfully');
                showNotification('Record deleted successfully');
                await loadRecords();
            } catch (error) {
                console.error('Error deleting record:', error);
                showNotification('Error deleting record: ' + error.message, 'error');
            } finally {
                toggleLoading(false);
            }
        }

        // Mark as Returned
        async function markAsReturned(id) {
            if (!confirm('Mark this bicycle as returned?')) return;

            toggleLoading(true);
            try {
                await db.collection('bicycleRecords').doc(id).update({
                    status: 'Returned',
                    returnDate: new Date().toISOString()
                });
                console.log('Bicycle marked as returned');
                showNotification('Bicycle marked as returned');
                await loadRecords();
            } catch (error) {
                console.error('Error marking as returned:', error);
                showNotification('Error marking as returned: ' + error.message, 'error');
            } finally {
                toggleLoading(false);
            }
        }

        // Check Departures
        function checkDepartures() {
            const today = new Date().toISOString().split('T')[0];
            const departingToday = records.filter(record => 
                record.departureDate === today && record.status !== 'Returned'
            );
            
            const departuresDiv = document.getElementById('todayDepartures');
            const departuresList = document.getElementById('departuresList');

            if (departingToday.length > 0) {
                departuresDiv.style.display = 'block';
                departuresList.innerHTML = departingToday.map(record => `
                    <div class="departure-item">
                        <div>Room ${record.roomNumber} - ${record.guestName} (Bicycle #${record.bicycleNumber})</div>
                        <button class="return-btn" onclick="markAsReturned('${record.id}')">Mark as Returned</button>
                    </div>
                `).join('');
            } else {
                departuresDiv.style.display = 'none';
            }
        }

        // Utility Functions
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString();
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.backgroundColor = type === 'success' ? '#4CAF50' : '#f44336';
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing application...');
            document.getElementById('issueDate').valueAsDate = new Date();
            loadRecords();

            // Setup real-time updates
            db.collection('bicycleRecords')
                .onSnapshot((snapshot) => {
                    console.log('Real-time update received');
                    loadRecords();
                }, (error) => {
                    console.error('Error in real-time updates:', error);
                });
        });

        // Error handling
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('Error:', msg, '\nURL:', url, '\nLine:', lineNo, '\nColumn:', columnNo, '\nError:', error);
            showNotification('An error occurred. Check console for details.', 'error');
            return false;
        };
    </script>
</body>
</html>

