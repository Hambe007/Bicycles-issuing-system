<!-- SECTION 1: HTML HEAD -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hotel Bicycle Management System</title>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    
    <!-- PDF.js for PDF parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
</head>

<!-- SECTION 2: CSS STYLES -->
<style>
    body {
        font-family: Arial, sans-serif;
        line-height: 1.6;
        margin: 0;
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
        background-color: #f5f6fa;
    }

    .header {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-align: center;
    }

    .departure-notice {
        background-color: #ffe6e6;
        padding: 15px;
        margin-bottom: 20px;
        border: 1px solid #ffcccc;
        border-radius: 8px;
    }

    .departure-item {
        background-color: white;
        padding: 10px;
        margin: 5px 0;
        border-radius: 4px;
        border: 1px solid #ffcccc;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .tab-container {
        margin-bottom: 20px;
    }

    .tab-buttons {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }

    .tab-button {
        padding: 10px 20px;
        background-color: #f0f0f0;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .tab-button.active {
        background-color: #4CAF50;
        color: white;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .search-section {
        background-color: white;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .search-group {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
    }

    .form-section {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }

    input[type="text"],
    input[type="date"],
    input[type="number"],
    textarea,
    select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
    }

    button {
        padding: 8px 15px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    button:hover {
        opacity: 0.9;
    }

    .print-btn { background-color: #2196F3; }
    .edit-btn { background-color: #ff9800; }
    .delete-btn { background-color: #f44336; }
    .return-btn { background-color: #4CAF50; }

    .priority-high {
        background-color: #ffebee;
        border-left: 4px solid #f44336;
    }

    .priority-medium {
        background-color: #fff3e0;
        border-left: 4px solid #ff9800;
    }

    .priority-low {
        background-color: #e8f5e9;
        border-left: 4px solid #4caf50;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        background-color: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    th, td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }

    th {
        background-color: #4CAF50;
        color: white;
    }

    .upload-section {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .arrangement-list {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .bicycle-select {
        width: 200px;
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #ddd;
        margin-right: 10px;
    }

    .status-ready {
        background-color: #e8f5e9;
        color: #2e7d32;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.9em;
    }

    .status-issued {
        background-color: #e3f2fd;
        color: #1565c0;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.9em;
    }

    .status-returned { color: #888; font-style: italic; }

    .notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 15px;
        background-color: #4CAF50;
        color: white;
        border-radius: 4px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        display: none;
        z-index: 1000;
    }

    @media (max-width: 768px) {
        .search-group {
            flex-direction: column;
        }
        
        .search-group input,
        .search-group button {
            width: 100%;
        }
        
        .departure-item {
            flex-direction: column;
            gap: 10px;
        }
    }

    @media print {
        .no-print {
            display: none !important;
        }
        
        body {
            padding: 0;
            background: white;
        }

        table {
            box-shadow: none;
        }
    }
</style>

<!-- SECTION 3: HTML BODY -->
<body>
    <div class="header">
        <h1>Hotel Bicycle Management System</h1>
    </div>

    <div id="todayDepartures" class="departure-notice" style="display: none;">
        <h3>Today's Departures:</h3>
        <div id="departuresList"></div>
    </div>

    <div class="tab-container no-print">
        <div class="tab-buttons">
            <button class="tab-button active" onclick="showTab('issuing')">Bicycle Issuing</button>
            <button class="tab-button" onclick="showTab('faulty')">Faulty Bicycles</button>
            <button class="tab-button" onclick="showTab('arrangement')">Bicycle Arrangement</button>
        </div>
    </div>

    <!-- Bicycle Issuing Tab -->
    <div id="issuingTab" class="tab-content active">
        <div class="search-section no-print">
            <div class="search-group">
                <input type="text" id="bicycleSearch" placeholder="Search by Bicycle Number...">
                <button onclick="searchByBicycle()">Search Bicycle</button>
            </div>
            <div class="search-group">
                <input type="text" id="roomSearch" placeholder="Search by Room Number...">
                <button onclick="searchByRoom()">Search Room</button>
            </div>
            <div class="search-group">
                <button onclick="resetSearch()">Reset Search</button>
                <button class="print-btn" onclick="printDepartures()">Print Today's Departures</button>
                <button class="print-btn" onclick="printRecords()">Print Records</button>
            </div>
        </div>

        <form id="bicycleForm" class="form-section no-print">
            <h2>Issue Bicycle</h2>
            <input type="hidden" id="editIndex">
            
            <div class="form-grid">
                <div>
                    <label for="roomNumber">Room Number:</label>
                    <input type="text" id="roomNumber" required>
                </div>
                
                <div>
                    <label for="guestName">Guest Name:</label>
                    <input type="text" id="guestName" required>
                </div>
                
                <div>
                    <label for="issueDate">Date of Issue:</label>
                    <input type="date" id="issueDate" required>
                </div>
                
                <div>
                    <label for="departureDate">Date of Departure:</label>
                    <input type="date" id="departureDate" required>
                </div>
                
                <div>
                    <label for="bicycleNumber">Bicycle Number:</label>
                    <select id="bicycleNumber" required>
                        <option value="">Select Bicycle</option>
                        <optgroup label="Adult Bicycles">
                            <!-- Will be populated by JavaScript -->
                        </optgroup>
                        <optgroup label="Kids Bicycles 16&quot;">
                            <!-- Will be populated by JavaScript -->
                        </optgroup>
                        <optgroup label="Kids Bicycles 18&quot;">
                            <!-- Will be populated by JavaScript -->
                        </optgroup>
                        <optgroup label="Kids Bicycles 20&quot;">
                            <!-- Will be populated by JavaScript -->
                        </optgroup>
                        <optgroup label="Libero Bicycles">
                            <!-- Will be populated by JavaScript -->
                        </optgroup>
                    </select>
                </div>
            </div>
            
            <button type="submit">Save Record</button>
        </form>

        <table id="recordsTable">
            <thead>
                <tr>
                    <th>Room Number</th>
                    <th>Guest Name</th>
                    <th>Issue Date</th>
                    <th>Departure Date</th>
                    <th>Bicycle Number</th>
                    <th>Status</th>
                    <th class="no-print">Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Faulty Bicycles Tab -->
    <div id="faultyTab" class="tab-content">
        <div class="search-section no-print">
            <div class="search-group">
                <input type="text" id="faultyBicycleSearch" placeholder="Search faulty bicycle number...">
                <button onclick="searchFaultyBicycle()">Search</button>
            </div>
            <div class="search-group">
                <button onclick="resetFaultySearch()">Reset</button>
                <button class="print-btn" onclick="printFaultyBicycles()">Print Faulty Bicycles</button>
            </div>
        </div>

        <form id="faultyBicycleForm" class="form-section no-print">
            <h2>Report Faulty Bicycle</h2>
            <input type="hidden" id="faultyEditIndex">
            
            <div class="form-grid">
                <div>
                    <label for="faultyBicycleNumber">Bicycle Number:</label>
                    <select id="faultyBicycleNumber" required>
                        <!-- Will be populated by JavaScript -->
                    </select>
                </div>
                
                <div>
                    <label for="issueDescription">Issue Description:</label>
                    <textarea id="issueDescription" required></textarea>
                </div>

                <div>
                    <label for="priority">Priority Level:</label>
                    <select id="priority" required>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>

                <div>
                    <label for="estimatedRepairTime">Estimated Repair Time (days):</label>
                    <input type="number" id="estimatedRepairTime" required min="1">
                </div>

                <div>
                    <label for="maintenanceNotes">Maintenance Notes:</label>
                    <textarea id="maintenanceNotes"></textarea>
                </div>
            </div>
            
            <button type="submit">Report Issue</button>
        </form>

        <table id="faultyBicycleTable">
            <thead>
                <tr>
                    <th>Bicycle Number</th>
                    <th>Issue Description</th>
                    <th>Priority</th>
                    <th>Status</th>
                    <th>Reported Date</th>
                    <th>Est. Repair Time</th>
                    <th class="no-print">Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Bicycle Arrangement Tab -->
    <div id="arrangementTab" class="tab-content">
        <div class="upload-section no-print">
            <h2>Upload Flight Arrival Information</h2>
            <input type="file" id="pdfUpload" accept=".pdf" onchange="handlePDFUpload(event)">
            <p>Upload PDF containing flight arrival information</p>
        </div>

        <div class="search-section no-print">
            <div class="search-group">
                <input type="date" id="arrangementDate" onchange="filterArrangements()">
                <button onclick="filterArrangements()">Filter by Date</button>
                <button onclick="resetArrangementFilter()">Reset</button>
                <button class="print-btn" onclick
                    <!-- Continuing from previous arrangement tab HTML -->
                <button class="print-btn" onclick="printArrangements()">Print Arrangements</button>
            </div>
        </div>

        <div class="arrangement-list">
            <table id="arrangementTable">
                <thead>
                    <tr>
                        <th>Room Number</th>
                        <th>Guest Name</th>
                        <th>Arrival Date</th>
                        <th>Departure Date</th>
                        <th>Bicycle Type</th>
                        <th>Status</th>
                        <th class="no-print">Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- Notification div -->
    <div id="notification" class="notification"></div>

<script>
   const firebaseConfig = {
  apiKey: "AIzaSyBjAGc8L0bkO_2RbWi0-rw7__lSHCoBrJQ",
  authDomain: "bicycle-issuing-system2.firebaseapp.com",
  projectId: "bicycle-issuing-system2",
  storageBucket: "bicycle-issuing-system2.firebasestorage.app",
  messagingSenderId: "64926990610",
  appId: "1:64926990610:web:f45390888ea1d0dfb5f3cb"
};

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Global variables
    let records = [];
    let faultyBicycles = [];
    let arrangements = [];
    const form = document.getElementById('bicycleForm');
    const faultyForm = document.getElementById('faultyBicycleForm');
    const table = document.getElementById('recordsTable').getElementsByTagName('tbody')[0];
    const faultyTable = document.getElementById('faultyBicycleTable').getElementsByTagName('tbody')[0];

    // Bicycle inventory arrays
    const adultBicycles = Array.from({length: 400}, (_, i) => `A${String(i + 1).padStart(3, '0')}`);
    const kidsBicycles = {
        '16inch': Array.from({length: 99}, (_, i) => `K${String(i + 1).padStart(2, '0')}-16`),
        '18inch': Array.from({length: 99}, (_, i) => `K${String(i + 1).padStart(2, '0')}-18`),
        '20inch': Array.from({length: 99}, (_, i) => `K${String(i + 1).padStart(2, '0')}-20`)
    };
    const liberoBicycles = Array.from({length: 40}, (_, i) => `Libero ${String(i + 1).padStart(2, '0')}`);

    // Populate bicycle dropdowns
    function populateBicycleDropdowns() {
        // Populate main bicycle form dropdown
        const mainSelect = document.getElementById('bicycleNumber');
        const adultGroup = mainSelect.querySelector('optgroup[label="Adult Bicycles"]');
        const kids16Group = mainSelect.querySelector('optgroup[label="Kids Bicycles 16"]');
        const kids18Group = mainSelect.querySelector('optgroup[label="Kids Bicycles 18"]');
        const kids20Group = mainSelect.querySelector('optgroup[label="Kids Bicycles 20"]');
        const liberoGroup = mainSelect.querySelector('optgroup[label="Libero Bicycles"]');

        // Clear existing options
        adultGroup.innerHTML = '';
        kids16Group.innerHTML = '';
        kids18Group.innerHTML = '';
        kids20Group.innerHTML = '';
        liberoGroup.innerHTML = '';

        // Add options
        adultBicycles.forEach(num => {
            adultGroup.appendChild(new Option(num, num));
        });
        kidsBicycles['16inch'].forEach(num => {
            kids16Group.appendChild(new Option(num, num));
        });
        kidsBicycles['18inch'].forEach(num => {
            kids18Group.appendChild(new Option(num, num));
        });
        kidsBicycles['20inch'].forEach(num => {
            kids20Group.appendChild(new Option(num, num));
        });
        liberoBicycles.forEach(num => {
            liberoGroup.appendChild(new Option(num, num));
        });

        // Populate faulty bicycle form dropdown
        const faultySelect = document.getElementById('faultyBicycleNumber');
        faultySelect.innerHTML = '<option value="">Select Bicycle</option>';
        
        // Add all bicycle types to faulty dropdown
        adultBicycles.forEach(num => {
            faultySelect.appendChild(new Option(num, num));
        });
        Object.values(kidsBicycles).flat().forEach(num => {
            faultySelect.appendChild(new Option(num, num));
        });
        liberoBicycles.forEach(num => {
            faultySelect.appendChild(new Option(num, num));
        });
    }

    // Format date function
    function formatDate(dateString) {
        return new Date(dateString).toLocaleDateString();
    }

    // Show notification
    function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.style.backgroundColor = type === 'success' ? '#4CAF50' : '#f44336';
        notification.style.display = 'block';
        setTimeout(() => {
            notification.style.display = 'none';
        }, 3000);
    }

    // Tab Management
    function showTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
        document.getElementById(tabName + 'Tab').classList.add('active');
        document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
    }

    // ==================
    // BICYCLE ISSUING FUNCTIONS
    // ==================

    // Load and display records
    function loadRecords() {
        db.collection('bicycleRecords')
            .orderBy('timestamp', 'desc')
            .get()
            .then((snapshot) => {
                records = [];
                snapshot.forEach((doc) => {
                    records.push({ id: doc.id, ...doc.data() });
                });
                displayRecords();
                checkDepartures();
            })
            .catch((error) => {
                console.error("Error loading records: ", error);
                showNotification('Error loading records', 'error');
            });
    }

    function displayRecords(recordsToShow = records) {
        table.innerHTML = '';
        recordsToShow.forEach((record, index) => {
            const row = table.insertRow();
            const statusClass = record.status === 'Returned' ? 'status-returned' : '';
            row.innerHTML = `
                <td>${record.roomNumber}</td>
                <td>${record.guestName}</td>
                <td>${formatDate(record.issueDate)}</td>
                <td>${formatDate(record.departureDate)}</td>
                <td>${record.bicycleNumber}</td>
                <td class="${statusClass}">${record.status || 'Active'}</td>
                <td class="no-print">
                    ${record.status !== 'Returned' ? `
                        <button class="edit-btn" onclick="editRecord(${index})">Edit</button>
                        <button class="return-btn" onclick="markAsReturned('${record.id}')">Return</button>
                        <button class="delete-btn" onclick="deleteRecord('${record.id}')">Delete</button>
                    ` : ''}
                </td>
            `;
        });
    }

    // Check departures
    function checkDepartures() {
        const today = new Date().toISOString().split('T')[0];
        const departingToday = records.filter(record => 
            record.departureDate === today && record.status !== 'Returned'
        );
        const departuresDiv = document.getElementById('todayDepartures');
        const departuresList = document.getElementById('departuresList');

        if (departingToday.length > 0) {
            departuresDiv.style.display = 'block';
            departuresList.innerHTML = departingToday.map(record => `
                <div class="departure-item">
                    <div>Room ${record.roomNumber} - ${record.guestName} (Bicycle #${record.bicycleNumber})</div>
                    <button class="return-btn" onclick="markAsReturned('${record.id}')">Mark as Returned</button>
                </div>
            `).join('');
        } else {
            departuresDiv.style.display = 'none';
        }
    }

    // Handle PDF upload
    function handlePDFUpload(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const typedarray = new Uint8Array(e.target.result);
                
                pdfjsLib.getDocument(typedarray).promise.then(function(pdf) {
                    let currentPage = 1;
                    const processPage = function(pageNumber) {
                        pdf.getPage(pageNumber).then(function(page) {
                            page.getTextContent().then(function(textContent) {
                                // Process text content and extract relevant information
                                const text = textContent.items.map(item => item.str).join(' ');
                                
                                // Parse text to extract room numbers, guest names, dates
                                // This is a simplified example - adjust parsing logic based on your PDF format
                                const rows = text.split('\n');
                                const newArrangements = rows.map(row => {
                                    const [roomNumber, guestName, arrivalDate, departureDate] = row.split(',');
                                    return {
                                        roomNumber: roomNumber.trim(),
                                        guestName: guestName.trim(),
                                        arrivalDate: arrivalDate.trim(),
                                        departureDate: departureDate.trim(),
                                        bicycleType: '',
                                        bicycleNumber: '',
                                        status: 'Pending'
                                    };
                                }).filter(arr => arr.roomNumber && arr.guestName);

                                arrangements = [...arrangements, ...newArrangements];
                                displayArrangements();
                                
                                if (currentPage < pdf.numPages) {
                                    currentPage++;
                                    processPage(currentPage);
                                }
                            });
                        });
                    };
                    
                    processPage(1);
                });
            };
            reader.readAsArrayBuffer(file);
            showNotification('PDF uploaded successfully');
        }
    }

    // Bicycle form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const record = {
            roomNumber: document.getElementById('roomNumber').value,
            guestName: document.getElementById('guestName').value,
            issueDate: document.getElementById('issueDate').value,
            departureDate: document.getElementById('departureDate').value,
            bicycleNumber: document.getElementById('bicycleNumber').value,
            status: 'Active',
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        const editIndex = document.getElementById('editIndex').value;

        if (editIndex !== '') {
            const docId = records[editIndex].id;
            db.collection('bicycleRecords').doc(docId).update(record)
                .then(() => {
                    showNotification('Record updated successfully');
                    form.reset();
                    document.getElementById('editIndex').value = '';
                    loadRecords();
                })
                .catch((error) => {
                    console.error("Error updating record: ", error);
                    showNotification('Error updating record', 'error');
                });
        } else {
            db.collection('bicycleRecords').add(record)
                .then(() => {
                    showNotification('Record added successfully');
                    form.reset();
                    loadRecords();
                })
                .catch((error) => {
                    console.error("Error adding record: ", error);
                    showNotification('Error adding record', 'error');
                });
        }
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        populateBicycleDropdowns();
        loadRecords();
        loadFaultyBicycles();
        
        // Set default dates
        document.getElementById('issueDate').valueAsDate = new Date();
        document.getElementById('arrangementDate').valueAsDate = new Date();
    });

    // Real-time updates
    db.collection('bicycleRecords').onSnapshot((snapshot) => {
        records = [];
        snapshot.forEach((doc) => {
            records.push({ id: doc.id, ...doc.data() });
        });
        displayRecords();
        checkDepartures();
    });

    db.collection('faultyBicycles').onSnapshot((snapshot) => {
        faultyBicycles = [];
        snapshot.forEach((doc) => {
            faultyBicycles.push({ id: doc.id, ...doc.data() });
        });
        displayFaultyBicycles();
    });
</script>
</body>
</html>
