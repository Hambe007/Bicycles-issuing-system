<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hotel Bicycle Management System</title>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>

    <!-- React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- PDF.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>

    <!-- Firebase Configuration -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBjAGc8L0bkO_2RbWi0-rw7__lSHCoBrJQ",
            authDomain: "bicycle-issuing-system2.firebaseapp.com",
            projectId: "bicycle-issuing-system2",
            storageBucket: "bicycle-issuing-system2.firebasestorage.app",
            messagingSenderId: "64926990610",
            appId: "1:64926990610:web:f45390888ea1d0dfb5f3cb"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Global Constants
        const BICYCLE_CONFIG = {
            ADULT: {
                PREFIX: 'A',
                MIN: 1,
                MAX: 400,
                PAD_LENGTH: 3,
                formatNumber: (num) => `A${num.toString().padStart(3, '0')}`,
                details: {
                    type: 'Adult Standard'
                }
            },
            KIDS: {
                PREFIX: 'K',
                MIN: 1,
                MAX: 99,
                PAD_LENGTH: 2,
                formatNumber: (num) => `K${num.toString().padStart(2, '0')}`,
                sizes: [
                    { value: '16', label: '16 inches' },
                    { value: '18', label: '18 inches' },
                    { value: '20', label: '20 inches' }
                ],
                getSizeLabel: (size) => `${size} inches`
            }
        };

        const BICYCLE_STATUS = {
            PENDING: 'Pending',
            ASSIGNED: 'Assigned',
            READY: 'Ready',
            ISSUED: 'Issued',
            RETURNED: 'Returned',
            MAINTENANCE: 'Maintenance'
        };

        // Firebase Connection Test
        async function testFirebaseConnection() {
            try {
                const testDoc = await db.collection('test').add({
                    test: true,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                await db.collection('test').doc(testDoc.id).delete();
                console.log('Firebase connection successful');
                return true;
            } catch (error) {
                console.error('Firebase connection error:', error);
                return false;
            }
        }
    </script>
</head>
<style>
    /* Base Styles */
    body {
        font-family: Arial, sans-serif;
        line-height: 1.6;
        margin: 0;
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
        background-color: #f5f6fa;
    }

    .header {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-align: center;
    }

    /* Tab Styles */
    .tab-container { margin-bottom: 20px; }
    .tab-buttons {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }
    .tab-button {
        padding: 10px 20px;
        background-color: #f0f0f0;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    .tab-button.active {
        background-color: #4CAF50;
        color: white;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Form and Input Styles */
    .form-section {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }
    input[type="text"],
    input[type="date"],
    input[type="number"],
    textarea,
    select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
    }

    /* Button Styles */
    button {
        padding: 8px 15px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
    }
    button:hover { opacity: 0.9; }
    button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }
    .print-btn { background-color: #2196F3; }
    .edit-btn { background-color: #ff9800; }
    .delete-btn { background-color: #f44336; }
    .assign-btn { background-color: #4CAF50; }

    /* Table Styles */
    table {
        width: 100%;
        border-collapse: collapse;
        background-color: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    th, td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }
    th {
        background-color: #4CAF50;
        color: white;
    }

    /* Bicycle Assignment Modal Styles */
    .bicycle-assignment-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .modal-content {
        background: white;
        border-radius: 12px;
        padding: 24px;
        width: 90%;
        max-width: 1000px;
        max-height: 90vh;
        overflow-y: auto;
    }

    .bicycle-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 16px;
        margin-top: 12px;
    }

    .bicycle-card {
        background: white;
        border: 2px solid #eee;
        border-radius: 8px;
        padding: 12px;
        cursor: pointer;
        position: relative;
        transition: all 0.2s ease;
    }

    .bicycle-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .bicycle-card.selected {
        border-color: #2196F3;
        background-color: #e3f2fd;
    }

    .bicycle-number {
        font-size: 1.2em;
        font-weight: bold;
        margin-bottom: 8px;
    }

    .bicycle-details {
        display: flex;
        justify-content: space-between;
        font-size: 0.9em;
        color: #666;
    }

    .size-group {
        margin-top: 16px;
    }

    .size-group h5 {
        color: #666;
        margin-bottom: 8px;
    }

    /* Status Indicators */
    .status-indicator {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.9em;
        display: inline-block;
    }
    .status-pending { background-color: #fff3e0; color: #f57c00; }
    .status-assigned { background-color: #e3f2fd; color: #1976d2; }
    .status-ready { background-color: #e8f5e9; color: #2e7d32; }
    .status-issued { background-color: #e8eaf6; color: #3f51b5; }

    /* Notification Styles */
    .notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 15px 25px;
        border-radius: 4px;
        background-color: #4CAF50;
        color: white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        display: none;
        z-index: 1100;
        animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    /* Selection Summary */
    .selection-summary {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 16px;
        margin: 20px 0;
    }

    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 8px;
        margin-top: 12px;
    }

    .summary-item {
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 0.9em;
    }

    .summary-item.adult {
        background: #e3f2fd;
        color: #1976d2;
    }

    .summary-item.kids {
        background: #e8f5e9;
        color: #2e7d32;
    }

    /* Modal Actions */
    .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 20px;
        border-top: 1px solid #eee;
        padding-top: 20px;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .tab-buttons { 
            flex-direction: column; 
        }
        .form-grid { 
            grid-template-columns: 1fr; 
        }
        .bicycle-grid {
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        }
        .modal-content {
            width: 95%;
            padding: 16px;
        }
    }

    @media print {
        .no-print { 
            display: none !important; 
        }
        body { 
            padding: 0; 
            background: white; 
        }
        table { 
            box-shadow: none; 
        }
    }
</style>
<body>
    <div class="header">
        <h1>Hotel Bicycle Management System</h1>
    </div>

    <div id="todayDepartures" class="departure-notice" style="display: none;">
        <h3>Today's Departures:</h3>
        <div id="departuresList"></div>
    </div>

    <div class="tab-container no-print">
        <div class="tab-buttons">
            <button class="tab-button active" onclick="showTab('issuing')">Bicycle Issuing</button>
            <button class="tab-button" onclick="showTab('faulty')">Faulty Bicycles</button>
            <button class="tab-button" onclick="showTab('arrival')">Arrival Preparation</button>
        </div>
    </div>

    <!-- Bicycle Issuing Tab -->
    <div id="issuingTab" class="tab-content active">
        <div class="search-section no-print">
            <div class="search-group">
                <input type="text" id="bicycleSearch" placeholder="Search by Bicycle Number...">
                <button onclick="searchByBicycle()">Search Bicycle</button>
            </div>
            <div class="search-group">
                <input type="text" id="roomSearch" placeholder="Search by Room Number...">
                <button onclick="searchByRoom()">Search Room</button>
            </div>
            <div class="search-group">
                <button onclick="resetSearch()">Reset Search</button>
                <button class="print-btn" onclick="printDepartures()">Print Today's Departures</button>
                <button class="print-btn" onclick="printRecords()">Print Records</button>
            </div>
        </div>

        <form id="bicycleForm" class="form-section no-print">
            <h2>Issue Bicycle</h2>
            <input type="hidden" id="editIndex">
            
            <div class="form-grid">
                <div>
                    <label for="roomNumber">Room Number:</label>
                    <input type="text" id="roomNumber" required>
                </div>
                
                <div>
                    <label for="guestName">Guest Name:</label>
                    <input type="text" id="guestName" required>
                </div>
                
                <div>
                    <label for="issueDate">Date of Issue:</label>
                    <input type="date" id="issueDate" required>
                </div>
                
                <div>
                    <label for="departureDate">Date of Departure:</label>
                    <input type="date" id="departureDate" required>
                </div>
                
                <div>
                    <label for="bicycleNumber">Bicycle Number:</label>
                    <select id="bicycleNumber" required>
                        <option value="">Select Bicycle</option>
                        <!-- Will be populated dynamically -->
                    </select>
                </div>
            </div>
            
            <button type="submit">Save Record</button>
        </form>

        <table id="recordsTable">
            <thead>
                <tr>
                    <th>Room Number</th>
                    <th>Guest Name</th>
                    <th>Issue Date</th>
                    <th>Departure Date</th>
                    <th>Bicycle Number</th>
                    <th>Status</th>
                    <th class="no-print">Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Faulty Bicycles Tab -->
    <div id="faultyTab" class="tab-content">
        <div class="search-section no-print">
            <div class="search-group">
                <input type="text" id="faultyBicycleSearch" placeholder="Search faulty bicycle number...">
                <button onclick="searchFaultyBicycle()">Search</button>
            </div>
            <div class="search-group">
                <button onclick="resetFaultySearch()">Reset</button>
                <button class="print-btn" onclick="printFaultyBicycles()">Print Faulty Bicycles</button>
            </div>
        </div>

        <form id="faultyBicycleForm" class="form-section no-print">
            <h2>Report Faulty Bicycle</h2>
            <input type="hidden" id="faultyEditIndex">
            
            <div class="form-grid">
                <div>
                    <label for="faultyBicycleNumber">Bicycle Number:</label>
                    <select id="faultyBicycleNumber" required>
                        <option value="">Select Bicycle</option>
                        <!-- Will be populated dynamically -->
                    </select>
                </div>
                
                <div>
                    <label for="issueDescription">Issue Description:</label>
                    <textarea id="issueDescription" required></textarea>
                </div>

                <div>
                    <label for="priority">Priority Level:</label>
                    <select id="priority" required>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>

                <div>
                    <label for="maintenanceNotes">Maintenance Notes:</label>
                    <textarea id="maintenanceNotes"></textarea>
                </div>
            </div>
            
            <button type="submit">Report Issue</button>
        </form>

        <table id="faultyBicycleTable">
            <thead>
                <tr>
                    <th>Bicycle Number</th>
                    <th>Issue Description</th>
                    <th>Priority</th>
                    <th>Status</th>
                    <th>Reported Date</th>
                    <th class="no-print">Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Arrival Preparation Tab -->
    <div id="arrivalTab" class="tab-content">
        <div id="arrival-preparation-root"></div>
    </div>

    <!-- Notification Container -->
    <div id="notification" class="notification"></div>
</body>
<script>
// Global variables
let records = [];
let faultyBicycles = [];
let availableBicycles = {
    adult: [],
    kids: []
};

// Utility Functions
function formatDate(dateString) {
    if (!dateString) return '';
    return new Date(dateString).toLocaleDateString();
}

function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.style.backgroundColor = type === 'success' ? '#4CAF50' : '#f44336';
    notification.style.display = 'block';
    setTimeout(() => {
        notification.style.display = 'none';
    }, 5000);
}

// Tab Management
function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
    document.getElementById(tabName + 'Tab').classList.add('active');
    document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
}

// Database Operations
async function loadRecords() {
    try {
        const snapshot = await db.collection('bicycleRecords')
            .orderBy('timestamp', 'desc')
            .get();
        
        records = [];
        snapshot.forEach(doc => {
            records.push({ id: doc.id, ...doc.data() });
        });
        
        displayRecords();
        checkDepartures();
    } catch (error) {
        console.error('Error loading records:', error);
        showNotification('Error loading records', 'error');
    }
}

async function loadFaultyBicycles() {
    try {
        const snapshot = await db.collection('faultyBicycles')
            .orderBy('timestamp', 'desc')
            .get();
        
        faultyBicycles = [];
        snapshot.forEach(doc => {
            faultyBicycles.push({ id: doc.id, ...doc.data() });
        });
        
        displayFaultyBicycles();
    } catch (error) {
        console.error('Error loading faulty bicycles:', error);
        showNotification('Error loading faulty bicycles', 'error');
    }
}

async function loadAvailableBicycles() {
    try {
        const snapshot = await db.collection('bicycleInventory')
            .where('status', '==', 'Available')
            .get();

        availableBicycles = {
            adult: [],
            kids: []
        };

        snapshot.forEach(doc => {
            const bike = { id: doc.id, ...doc.data() };
            if (bike.number.startsWith('A')) {
                availableBicycles.adult.push(bike);
            } else if (bike.number.startsWith('K')) {
                availableBicycles.kids.push(bike);
            }
        });

        // Update bicycle selection dropdowns
        updateBicycleDropdowns();
    } catch (error) {
        console.error('Error loading available bicycles:', error);
        showNotification('Error loading bicycle inventory', 'error');
    }
}

function updateBicycleDropdowns() {
    // Update regular bicycle dropdown
    const bicycleSelect = document.getElementById('bicycleNumber');
    bicycleSelect.innerHTML = '<option value="">Select Bicycle</option>';
    
    // Add adult bicycles
    if (availableBicycles.adult.length > 0) {
        const adultOptgroup = document.createElement('optgroup');
        adultOptgroup.label = 'Adult Bicycles';
        availableBicycles.adult.forEach(bike => {
            const option = document.createElement('option');
            option.value = bike.number;
            option.textContent = `${bike.number} (Adult)`;
            adultOptgroup.appendChild(option);
        });
        bicycleSelect.appendChild(adultOptgroup);
    }

    // Add kids bicycles
    if (availableBicycles.kids.length > 0) {
        const kidsOptgroup = document.createElement('optgroup');
        kidsOptgroup.label = 'Kids Bicycles';
        availableBicycles.kids.forEach(bike => {
            const option = document.createElement('option');
            option.value = bike.number;
            option.textContent = `${bike.number} (${bike.size}")`;
            kidsOptgroup.appendChild(option);
        });
        bicycleSelect.appendChild(kidsOptgroup);
    }

    // Update faulty bicycle dropdown
    const faultyBicycleSelect = document.getElementById('faultyBicycleNumber');
    faultyBicycleSelect.innerHTML = '<option value="">Select Bicycle</option>';
    [...availableBicycles.adult, ...availableBicycles.kids].forEach(bike => {
        const option = document.createElement('option');
        option.value = bike.number;
        option.textContent = bike.number + (bike.size ? ` (${bike.size}")` : '');
        faultyBicycleSelect.appendChild(option);
    });
}

// Display Functions
function displayRecords(recordsToShow = records) {
    const table = document.querySelector('#recordsTable tbody');
    if (!table) return;

    table.innerHTML = recordsToShow.map(record => `
        <tr>
            <td>${record.roomNumber}</td>
            <td>${record.guestName}</td>
            <td>${formatDate(record.issueDate)}</td>
            <td>${formatDate(record.departureDate)}</td>
            <td>${record.bicycleNumber}</td>
            <td>
                <span class="status-indicator status-${record.status?.toLowerCase() || 'active'}">
                    ${record.status || 'Active'}
                </span>
            </td>
            <td class="no-print">
                ${record.status !== 'Returned' ? `
                    <button class="edit-btn" onclick="editRecord('${record.id}')">Edit</button>
                    <button class="return-btn" onclick="markAsReturned('${record.id}')">Return</button>
                    <button class="delete-btn" onclick="deleteRecord('${record.id}')">Delete</button>
                ` : ''}
            </td>
        </tr>
    `).join('');
}

// Check Departures
function checkDepartures() {
    const today = new Date().toISOString().split('T')[0];
    const departingToday = records.filter(record => 
        record.departureDate === today && record.status !== 'Returned'
    );

    const departuresDiv = document.getElementById('todayDepartures');
    const departuresList = document.getElementById('departuresList');

    if (departingToday.length > 0) {
        departuresDiv.style.display = 'block';
        departuresList.innerHTML = departingToday.map(record => `
            <div class="departure-item">
                <div>Room ${record.roomNumber} - ${record.guestName} (Bicycle #${record.bicycleNumber})</div>
                <button class="return-btn" onclick="markAsReturned('${record.id}')">Mark as Returned</button>
            </div>
        `).join('');
    } else {
        departuresDiv.style.display = 'none';
    }
}

// Search Functions
function searchByBicycle() {
    const searchTerm = document.getElementById('bicycleSearch').value.toLowerCase();
    if (!searchTerm) {
        showNotification('Please enter a bicycle number', 'error');
        return;
    }
    const filtered = records.filter(record => 
        record.bicycleNumber.toLowerCase().includes(searchTerm)
    );
    displayRecords(filtered);
}

function searchByRoom() {
    const searchTerm = document.getElementById('roomSearch').value.toLowerCase();
    if (!searchTerm) {
        showNotification('Please enter a room number', 'error');
        return;
    }
    const filtered = records.filter(record => 
        record.roomNumber.toLowerCase().includes(searchTerm)
    );
    displayRecords(filtered);
}

function resetSearch() {
    document.getElementById('bicycleSearch').value = '';
    document.getElementById('roomSearch').value = '';
    displayRecords();
}

// Initialize System
document.addEventListener('DOMContentLoaded', async () => {
    try {
        // Test Firebase connection
        const connected = await testFirebaseConnection();
        if (!connected) {
            showNotification('Failed to connect to database', 'error');
            return;
        }

        // Initialize PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';
        
        // Load initial data
        await Promise.all([
            loadRecords(),
            loadFaultyBicycles(),
            loadAvailableBicycles()
        ]);

        // Set today's date as default for issue date
        const issueDateInput = document.getElementById('issueDate');
        if (issueDateInput) {
            issueDateInput.valueAsDate = new Date();
        }

        showNotification('System initialized successfully');
    } catch (error) {
        console.error('Initialization error:', error);
        showNotification('Error initializing system', 'error');
    }
});
</script>
<script>
// Record Management Functions
async function editRecord(id) {
    const record = records.find(r => r.id === id);
    if (!record) return;

    document.getElementById('roomNumber').value = record.roomNumber;
    document.getElementById('guestName').value = record.guestName;
    document.getElementById('issueDate').value = record.issueDate;
    document.getElementById('departureDate').value = record.departureDate;
    document.getElementById('bicycleNumber').value = record.bicycleNumber;
    document.getElementById('editIndex').value = id;
}

async function markAsReturned(id) {
    if (!confirm('Mark this bicycle as returned?')) return;

    try {
        const record = records.find(r => r.id === id);
        if (!record) return;

        // Update record status
        await db.collection('bicycleRecords').doc(id).update({
            status: 'Returned',
            returnDate: new Date().toISOString()
        });

        // Update bicycle inventory status
        await db.collection('bicycleInventory')
            .doc(record.bicycleNumber)
            .update({
                status: 'Available',
                lastReturn: new Date().toISOString(),
                currentAssignment: null
            });

        showNotification('Bicycle marked as returned');
        await Promise.all([loadRecords(), loadAvailableBicycles()]);
    } catch (error) {
        console.error('Error marking as returned:', error);
        showNotification('Error updating record', 'error');
    }
}

async function deleteRecord(id) {
    if (!confirm('Are you sure you want to delete this record?')) return;

    try {
        const record = records.find(r => r.id === id);
        if (!record) return;

        await db.collection('bicycleRecords').doc(id).delete();
        
        // Reset bicycle status if it was active
        if (record.status !== 'Returned') {
            await db.collection('bicycleInventory')
                .doc(record.bicycleNumber)
                .update({
                    status: 'Available',
                    currentAssignment: null
                });
        }

        showNotification('Record deleted successfully');
        await Promise.all([loadRecords(), loadAvailableBicycles()]);
    } catch (error) {
        console.error('Error deleting record:', error);
        showNotification('Error deleting record', 'error');
    }
}

// Faulty Bicycle Functions
function displayFaultyBicycles(bicyclesToShow = faultyBicycles) {
    const table = document.querySelector('#faultyBicycleTable tbody');
    if (!table) return;

    table.innerHTML = bicyclesToShow.map(bicycle => `
        <tr class="priority-${bicycle.priority}">
            <td>${bicycle.bicycleNumber}</td>
            <td>${bicycle.issueDescription}</td>
            <td>${bicycle.priority.toUpperCase()}</td>
            <td>${bicycle.status}</td>
            <td>${formatDate(bicycle.reportedDate)}</td>
            <td class="no-print">
                ${bicycle.status !== 'Fixed' ? `
                    <button class="edit-btn" onclick="editFaultyBicycle('${bicycle.id}')">Edit</button>
                    <button class="return-btn" onclick="markAsFixed('${bicycle.id}')">Mark Fixed</button>
                ` : ''}
            </td>
        </tr>
    `).join('');
}

async function editFaultyBicycle(id) {
    const bicycle = faultyBicycles.find(b => b.id === id);
    if (!bicycle) return;

    document.getElementById('faultyBicycleNumber').value = bicycle.bicycleNumber;
    document.getElementById('issueDescription').value = bicycle.issueDescription;
    document.getElementById('priority').value = bicycle.priority;
    document.getElementById('maintenanceNotes').value = bicycle.maintenanceNotes || '';
    document.getElementById('faultyEditIndex').value = id;
}

async function markAsFixed(id) {
    if (!confirm('Mark this bicycle as fixed?')) return;

    try {
        const bicycle = faultyBicycles.find(b => b.id === id);
        if (!bicycle) return;

        const fixedDate = new Date().toISOString();
        await db.collection('faultyBicycles').doc(id).update({
            status: 'Fixed',
            fixedDate: fixedDate,
            maintenanceHistory: firebase.firestore.FieldValue.arrayUnion({
                date: fixedDate,
                action: 'Fixed',
                notes: 'Bicycle repaired and ready for use'
            })
        });

        // Update bicycle inventory status
        await db.collection('bicycleInventory')
            .doc(bicycle.bicycleNumber)
            .update({
                status: 'Available',
                lastMaintenance: fixedDate,
                condition: 'Good'
            });

        showNotification('Bicycle marked as fixed');
        await Promise.all([loadFaultyBicycles(), loadAvailableBicycles()]);
    } catch (error) {
        console.error('Error marking as fixed:', error);
        showNotification('Error updating bicycle status', 'error');
    }
}

// Form Submissions
document.getElementById('bicycleForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const editId = document.getElementById('editIndex').value;
    const bicycleNumber = document.getElementById('bicycleNumber').value;

    // Validate bicycle availability
    if (!editId) {
        const isAvailable = [...availableBicycles.adult, ...availableBicycles.kids]
            .some(bike => bike.number === bicycleNumber && bike.status === 'Available');
        
        if (!isAvailable) {
            showNotification('Selected bicycle is not available', 'error');
            return;
        }
    }

    const record = {
        roomNumber: document.getElementById('roomNumber').value,
        guestName: document.getElementById('guestName').value,
        issueDate: document.getElementById('issueDate').value,
        departureDate: document.getElementById('departureDate').value,
        bicycleNumber: bicycleNumber,
        status: 'Active',
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
        if (editId) {
            await db.collection('bicycleRecords').doc(editId).update(record);
            showNotification('Record updated successfully');
        } else {
            await db.collection('bicycleRecords').add(record);
            // Update bicycle inventory status
            await db.collection('bicycleInventory').doc(bicycleNumber).update({
                status: 'Assigned',
                currentAssignment: {
                    roomNumber: record.roomNumber,
                    guestName: record.guestName,
                    issueDate: record.issueDate,
                    departureDate: record.departureDate
                }
            });
            showNotification('Record added successfully');
        }

        e.target.reset();
        document.getElementById('editIndex').value = '';
        await Promise.all([loadRecords(), loadAvailableBicycles()]);
    } catch (error) {
        console.error('Error with record:', error);
        showNotification('Error processing record', 'error');
    }
});

document.getElementById('faultyBicycleForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const editId = document.getElementById('faultyEditIndex').value;
    const bicycleNumber = document.getElementById('faultyBicycleNumber').value;
    const issueDescription = document.getElementById('issueDescription').value;
    const priority = document.getElementById('priority').value;
    const maintenanceNotes = document.getElementById('maintenanceNotes').value;

    const faultyBicycle = {
        bicycleNumber,
        issueDescription,
        priority,
        maintenanceNotes,
        status: 'Under Repair',
        reportedDate: new Date().toISOString(),
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        maintenanceHistory: [{
            date: new Date().toISOString(),
            action: editId ? 'Updated' : 'Reported',
            notes: maintenanceNotes
        }]
    };

    try {
        if (editId) {
            const existingBicycle = faultyBicycles.find(b => b.id === editId);
            faultyBicycle.maintenanceHistory = [
                ...(existingBicycle.maintenanceHistory || []),
                ...faultyBicycle.maintenanceHistory
            ];
            
            await db.collection('faultyBicycles').doc(editId).update(faultyBicycle);
            showNotification('Faulty bicycle record updated');
        } else {
            await db.collection('faultyBicycles').add(faultyBicycle);
            // Update bicycle inventory status
            await db.collection('bicycleInventory').doc(bicycleNumber).update({
                status: 'Maintenance',
                currentIssue: {
                    description: issueDescription,
                    priority: priority,
                    reportedDate: new Date().toISOString()
                }
            });
            showNotification('Faulty bicycle reported successfully');
        }

        e.target.reset();
        document.getElementById('faultyEditIndex').value = '';
        await Promise.all([loadFaultyBicycles(), loadAvailableBicycles()]);
    } catch (error) {
        console.error('Error with faulty bicycle:', error);
        showNotification('Error processing faulty bicycle record', 'error');
    }
});
</script>
<script>
// PDF Processing Utilities
const PDFProcessor = {
    async extractText(file) {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let extractedText = '';
        
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            extractedText += textContent.items.map(item => item.str).join(' ');
        }
        
        return extractedText;
    },

    parseArrivalData(text) {
        const arrivals = [];
        
        // Split text into sections (one per guest)
        const sections = text.split(/(?=Room\s*\d+)/gi);

        sections.forEach(section => {
            if (!section.trim()) return;

            const roomMatch = section.match(/Room\s*(\d+)/i);
            const guestMatch = section.match(/Guest:\s*([^\n]+)/i);
            const dates = section.match(/\d{2}[-/]\d{2}[-/]\d{4}/g);
            const bicycleMatch = section.match(/Bicycles?:?\s*(\d+)?(?:\s*Adults?)?,?\s*(\d+)?\s*(?:Child(?:ren)?)?/i);

            if (roomMatch && guestMatch && dates?.length >= 2) {
                arrivals.push({
                    id: Date.now() + Math.random().toString(36).substr(2, 9),
                    roomNumber: roomMatch[1],
                    guestName: guestMatch[1].trim(),
                    arrivalDate: this.formatDate(dates[0]),
                    departureDate: this.formatDate(dates[1]),
                    bicycleRequest: {
                        adults: parseInt(bicycleMatch?.[1]) || 2, // Default to 2 adult bikes
                        children: parseInt(bicycleMatch?.[2]) || 0
                    },
                    status: 'Pending',
                    assignedBicycles: [],
                    timestamp: new Date().toISOString()
                });
            }
        });

        return arrivals;
    },

    formatDate(dateStr) {
        const [day, month, year] = dateStr.split(/[-/]/).map(num => num.padStart(2, '0'));
        return `${year}-${month}-${day}`;
    }
};

// Arrival Preparation Component
const ArrivalPreparation = () => {
    const [arrivals, setArrivals] = React.useState([]);
    const [uploadError, setUploadError] = React.useState('');
    const [isLoading, setIsLoading] = React.useState(false);
    const [showAssignModal, setShowAssignModal] = React.useState(false);
    const [selectedArrival, setSelectedArrival] = React.useState(null);

    React.useEffect(() => {
        loadSavedArrivals();
    }, []);

    const loadSavedArrivals = async () => {
        try {
            const snapshot = await db.collection('arrivalRequests')
                .where('arrivalDate', '>=', new Date().toISOString().split('T')[0])
                .orderBy('arrivalDate')
                .get();

            const loadedArrivals = [];
            snapshot.forEach(doc => {
                loadedArrivals.push({ id: doc.id, ...doc.data() });
            });

            setArrivals(loadedArrivals);
        } catch (error) {
            console.error('Error loading arrivals:', error);
            showNotification('Error loading arrival requests', 'error');
        }
    };

    const handleFileUpload = async (event) => {
        const file = event.target.files[0];
        if (!file || file.type !== 'application/pdf') {
            setUploadError('Please upload a PDF file');
            return;
        }

        setIsLoading(true);
        setUploadError('');

        try {
            // Process PDF
            const extractedText = await PDFProcessor.extractText(file);
            const parsedArrivals = PDFProcessor.parseArrivalData(extractedText);

            if (parsedArrivals.length === 0) {
                throw new Error('No valid arrival data found in PDF');
            }

            // Store in Firestore
            const batch = db.batch();
            parsedArrivals.forEach(arrival => {
                const docRef = db.collection('arrivalRequests').doc();
                batch.set(docRef, arrival);
            });
            await batch.commit();

            setArrivals(prev => [...prev, ...parsedArrivals]);
            showNotification(`Successfully processed ${parsedArrivals.length} arrivals`);
            event.target.value = '';
        } catch (error) {
            console.error('Error processing PDF:', error);
            setUploadError(error.message || 'Error processing PDF file');
        } finally {
            setIsLoading(false);
        }
    };

    // AssignBicycleModal Component
    const AssignBicycleModal = ({ arrival, onClose }) => {
        const [selectedBicycles, setSelectedBicycles] = React.useState({
            adult: [],
            kids: []
        });

        const handleAssign = async () => {
            try {
                const allBicycles = [
                    ...selectedBicycles.adult.map(num => ({ number: num, type: 'adult' })),
                    ...selectedBicycles.kids.map(num => ({ number: num, type: 'kids' }))
                ];

                await db.collection('arrivalRequests').doc(arrival.id).update({
                    assignedBicycles: allBicycles,
                    status: 'Assigned',
                    assignmentDate: new Date().toISOString()
                });

                // Update bicycle inventory
                const batch = db.batch();
                allBicycles.forEach(bike => {
                    const bikeRef = db.collection('bicycleInventory').doc(bike.number);
                    batch.update(bikeRef, {
                        status: 'Reserved',
                        reservedFor: {
                            roomNumber: arrival.roomNumber,
                            guestName: arrival.guestName,
                            arrivalDate: arrival.arrivalDate
                        }
                    });
                });
                await batch.commit();

                showNotification('Bicycles assigned successfully');
                onClose();
                loadSavedArrivals();
            } catch (error) {
                console.error('Error assigning bicycles:', error);
                showNotification('Error assigning bicycles', 'error');
            }
        };

        return React.createElement('div', { className: 'modal' },
            React.createElement('div', { className: 'modal-content' },
                React.createElement('h3', null, `Assign Bicycles - Room ${arrival.roomNumber}`),
                React.createElement('div', { className: 'bicycle-grid' },
                    // Adult Bicycles
                    React.createElement('div', { className: 'bicycle-section' },
                        React.createElement('h4', null, 'Adult Bicycles'),
                        availableBicycles.adult.map(bike => 
                            React.createElement('div', {
                                key: bike.number,
                                className: `bicycle-card ${
                                    selectedBicycles.adult.includes(bike.number) ? 'selected' : ''
                                }`,
                                onClick: () => handleBicycleSelection(bike.number, 'adult')
                            }, bike.number)
                        )
                    ),
                    // Kids Bicycles (if requested)
                    arrival.bicycleRequest.children > 0 &&
                    React.createElement('div', { className: 'bicycle-section' },
                        React.createElement('h4', null, 'Kids Bicycles'),
                        availableBicycles.kids.map(bike => 
                            React.createElement('div', {
                                key: bike.number,
                                className: `bicycle-card ${
                                    selectedBicycles.kids.includes(bike.number) ? 'selected' : ''
                                }`,
                                onClick: () => handleBicycleSelection(bike.number, 'kids')
                            }, `${bike.number} (${bike.size}")`)
                        )
                    )
                ),
                React.createElement('div', { className: 'modal-actions' },
                    React.createElement('button', {
                        onClick: handleAssign,
                        className: 'assign-btn'
                    }, 'Confirm Assignment'),
                    React.createElement('button', {
                        onClick: onClose,
                        className: 'cancel-btn'
                    }, 'Cancel')
                )
            )
        );
    };

    return React.createElement('div', { className: 'arrival-preparation' },
        // File Upload Section
        React.createElement('div', { className: 'upload-section' },
            React.createElement('input', {
                type: 'file',
                accept: '.pdf',
                onChange: handleFileUpload,
                className: 'file-input'
            }),
            uploadError && React.createElement('div', { className: 'error' }, uploadError),
            isLoading && React.createElement('div', { className: 'loading' }, 'Processing...')
        ),

        // Arrivals Table
        React.createElement('table', null,
            React.createElement('thead', null,
                React.createElement('tr', null,
                    React.createElement('th', null, 'Room'),
                    React.createElement('th', null, 'Guest'),
                    React.createElement('th', null, 'Arrival'),
                    React.createElement('th', null, 'Departure'),
                    React.createElement('th', null, 'Bicycles'),
                    React.createElement('th', null, 'Status'),
                    React.createElement('th', null, 'Actions')
                )
            ),
            React.createElement('tbody', null,
                arrivals.map(arrival => 
                    React.createElement('tr', { key: arrival.id },
                        React.createElement('td', null, arrival.roomNumber),
                        React.createElement('td', null, arrival.guestName),
                        React.createElement('td', null, formatDate(arrival.arrivalDate)),
                        React.createElement('td', null, formatDate(arrival.departureDate)),
                        React.createElement('td', null, 
                            `${arrival.bicycleRequest.adults} Adult, ${arrival.bicycleRequest.children} Kids`
                        ),
                        React.createElement('td', null, arrival.status),
                        React.createElement('td', null,
                            arrival.status === 'Pending' &&
                            React.createElement('button', {
                                onClick: () => {
                                    setSelectedArrival(arrival);
                                    setShowAssignModal(true);
                                },
                                className: 'assign-btn'
                            }, 'Assign Bicycles')
                        )
                    )
                )
            )
        ),

        // Assignment Modal
        showAssignModal && selectedArrival &&
        React.createElement(AssignBicycleModal, {
            arrival: selectedArrival,
            onClose: () => {
                setShowAssignModal(false);
                setSelectedArrival(null);
            }
        })
    );
};

// Initialize React Component
document.addEventListener('DOMContentLoaded', () => {
    const arrivalRoot = document.getElementById('arrival-preparation-root');
    if (arrivalRoot) {
        ReactDOM.createRoot(arrivalRoot).render(React.createElement(ArrivalPreparation));
    }
});
</script>
<script>
// Print Functions
function printDepartures() {
    const today = new Date().toLocaleDateString();
    const departingToday = records.filter(record => 
        record.departureDate === new Date().toISOString().split('T')[0] && 
        record.status !== 'Returned'
    );

    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Today's Departures - ${today}</title>
            <style>
                body { 
                    font-family: Arial, sans-serif; 
                    padding: 20px; 
                    margin: 0;
                }
                .header {
                    text-align: center;
                    margin-bottom: 20px;
                    padding-bottom: 10px;
                    border-bottom: 2px solid #4CAF50;
                }
                .header h1 {
                    color: #2c3e50;
                    margin: 0;
                }
                .header .date {
                    color: #666;
                    font-size: 0.9em;
                }
                table { 
                    width: 100%; 
                    border-collapse: collapse; 
                    margin-top: 20px;
                }
                th, td { 
                    border: 1px solid #ddd; 
                    padding: 12px; 
                    text-align: left; 
                }
                th { 
                    background-color: #4CAF50; 
                    color: white;
                }
                .bicycle-info {
                    font-weight: bold;
                    color: #2196F3;
                }
                .footer {
                    margin-top: 30px;
                    text-align: center;
                    font-size: 0.8em;
                    color: #666;
                }
                @media print {
                    .header {
                        border-bottom-color: #000;
                    }
                    th {
                        background-color: #eee !important;
                        color: #000 !important;
                    }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>Today's Bicycle Departures</h1>
                <div class="date">${today}</div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Room</th>
                        <th>Guest Name</th>
                        <th>Bicycle</th>
                        <th>Issue Date</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${departingToday.map(record => `
                        <tr>
                            <td>${record.roomNumber}</td>
                            <td>${record.guestName}</td>
                            <td class="bicycle-info">${record.bicycleNumber}</td>
                            <td>${formatDate(record.issueDate)}</td>
                            <td>${record.status || 'Active'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            <div class="footer">
                <p>Total Departures: ${departingToday.length}</p>
                <p>Generated on ${new Date().toLocaleString()}</p>
            </div>
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

function printFaultyBicycles() {
    const today = new Date().toLocaleDateString();
    const faultyBikesUnderRepair = faultyBicycles.filter(b => b.status !== 'Fixed');

    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Faulty Bicycles Report - ${today}</title>
            <style>
                body { 
                    font-family: Arial, sans-serif; 
                    padding: 20px;
                    margin: 0;
                }
                .header {
                    text-align: center;
                    margin-bottom: 20px;
                    padding-bottom: 10px;
                    border-bottom: 2px solid #f44336;
                }
                .priority-high { 
                    background-color: #ffebee; 
                    border-left: 4px solid #f44336;
                }
                .priority-medium { 
                    background-color: #fff3e0; 
                    border-left: 4px solid #ff9800;
                }
                .priority-low { 
                    background-color: #e8f5e9; 
                    border-left: 4px solid #4caf50;
                }
                table { 
                    width: 100%; 
                    border-collapse: collapse; 
                    margin-top: 20px;
                }
                th, td { 
                    border: 1px solid #ddd; 
                    padding: 12px; 
                    text-align: left; 
                }
                th { 
                    background-color: #f44336; 
                    color: white;
                }
                .maintenance-notes {
                    font-style: italic;
                    color: #666;
                }
                .summary {
                    margin: 20px 0;
                    padding: 15px;
                    background: #f5f5f5;
                    border-radius: 4px;
                }
                .footer {
                    margin-top: 30px;
                    text-align: center;
                    font-size: 0.8em;
                    color: #666;
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>Faulty Bicycles Report</h1>
                <div class="date">${today}</div>
            </div>
            <div class="summary">
                <h3>Summary</h3>
                <p>Total Bicycles Under Repair: ${faultyBikesUnderRepair.length}</p>
                <p>High Priority: ${faultyBikesUnderRepair.filter(b => b.priority === 'high').length}</p>
                <p>Medium Priority: ${faultyBikesUnderRepair.filter(b => b.priority === 'medium').length}</p>
                <p>Low Priority: ${faultyBikesUnderRepair.filter(b => b.priority === 'low').length}</p>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Bicycle Number</th>
                        <th>Issue Description</th>
                        <th>Priority</th>
                        <th>Status</th>
                        <th>Reported Date</th>
                        <th>Maintenance Notes</th>
                    </tr>
                </thead>
                <tbody>
                    ${faultyBikesUnderRepair.map(bicycle => `
                        <tr class="priority-${bicycle.priority}">
                            <td>${bicycle.bicycleNumber}</td>
                            <td>${bicycle.issueDescription}</td>
                            <td>${bicycle.priority.toUpperCase()}</td>
                            <td>${bicycle.status}</td>
                            <td>${formatDate(bicycle.reportedDate)}</td>
                            <td class="maintenance-notes">${bicycle.maintenanceNotes || 'No notes'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            <div class="footer">
                <p>Generated on ${new Date().toLocaleString()}</p>
            </div>
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

function printRecords() {
    const today = new Date().toLocaleDateString();
    const activeRecords = records.filter(record => record.status !== 'Returned');

    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Active Bicycle Records - ${today}</title>
            <style>
                body { 
                    font-family: Arial, sans-serif; 
                    padding: 20px; 
                    margin: 0;
                }
                .header {
                    text-align: center;
                    margin-bottom: 20px;
                    padding-bottom: 10px;
                    border-bottom: 2px solid #2196F3;
                }
                table { 
                    width: 100%; 
                    border-collapse: collapse; 
                    margin-top: 20px;
                }
                th, td { 
                    border: 1px solid #ddd; 
                    padding: 12px; 
                    text-align: left; 
                }
                th { 
                    background-color: #2196F3; 
                    color: white;
                }
                .status-cell {
                    font-weight: bold;
                }
                .status-active { color: #4CAF50; }
                .summary {
                    margin: 20px 0;
                    padding: 15px;
                    background: #f5f5f5;
                    border-radius: 4px;
                }
                .footer {
                    margin-top: 30px;
                    text-align: center;
                    font-size: 0.8em;
                    color: #666;
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>Active Bicycle Records</h1>
                <div class="date">${today}</div>
            </div>
            <div class="summary">
                <h3>Summary</h3>
                <p>Total Active Records: ${activeRecords.length}</p>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Room Number</th>
                        <th>Guest Name</th>
                        <th>Issue Date</th>
                        <th>Departure Date</th>
                        <th>Bicycle Number</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${activeRecords.map(record => `
                        <tr>
                            <td>${record.roomNumber}</td>
                            <td>${record.guestName}</td>
                            <td>${formatDate(record.issueDate)}</td>
                            <td>${formatDate(record.departureDate)}</td>
                            <td>${record.bicycleNumber}</td>
                            <td class="status-cell status-${record.status?.toLowerCase() || 'active'}">
                                ${record.status || 'Active'}
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            <div class="footer">
                <p>Generated on ${new Date().toLocaleString()}</p>
            </div>
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

// Add closing HTML tag
</script>
</html>