```javascript
// Add this as the first <script> section after the HTML

<script>
// Firebase Configuration
const firebaseConfig = {
    apiKey: "AIzaSyBjAGc8L0bkO_2RbWi0-rw7__lSHCoBrJQ",
    authDomain: "bicycle-issuing-system2.firebaseapp.com",
    projectId: "bicycle-issuing-system2",
    storageBucket: "bicycle-issuing-system2.firebasestorage.app",
    messagingSenderId: "64926990610",
    appId: "1:64926990610:web:f45390888ea1d0dfb5f3cb"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Global State Management
const AppState = {
    records: [],
    faultyBicycles: [],
    arrangements: [],
    initialized: false
};

// Bicycle Inventory Configuration
const BicycleInventory = {
    types: {
        adult: {
            prefix: 'A',
            start: 1,
            end: 400,
            pad: 3,
            label: 'Adult Bicycle'
        },
        kids16: {
            prefix: 'K',
            start: 1,
            end: 99,
            pad: 2,
            suffix: '-16',
            label: 'Kids 16"'
        },
        kids18: {
            prefix: 'K',
            start: 1,
            end: 99,
            pad: 2,
            suffix: '-18',
            label: 'Kids 18"'
        },
        kids20: {
            prefix: 'K',
            start: 1,
            end: 99,
            pad: 2,
            suffix: '-20',
            label: 'Kids 20"'
        },
        libero: {
            prefix: 'Libero ',
            start: 1,
            end: 40,
            pad: 2,
            label: 'Libero (With Child Seat)'
        }
    },

    inventory: new Map(),

    initialize() {
        this.inventory.clear();
        Object.entries(this.types).forEach(([type, config]) => {
            for (let i = config.start; i <= config.end; i++) {
                const number = this.formatNumber(type, i);
                this.inventory.set(number, {
                    type,
                    available: true,
                    status: 'Available',
                    details: null
                });
            }
        });
    },

    formatNumber(type, number) {
        const config = this.types[type];
        const paddedNumber = String(number).padStart(config.pad, '0');
        return `${config.prefix}${paddedNumber}${config.suffix || ''}`;
    },

    updateStatus() {
        // Reset all to available
        this.initialize();

        // Mark unavailable based on active records
        AppState.records.forEach(record => {
            if (record.status !== 'Returned' && record.bicycleNumber) {
                this.setStatus(record.bicycleNumber, false, 'In Use', {
                    room: record.roomNumber,
                    guest: record.guestName,
                    until: record.departureDate
                });
            }
        });

        // Mark faulty bicycles
        AppState.faultyBicycles.forEach(bicycle => {
            if (bicycle.status !== 'Fixed' && bicycle.bicycleNumber) {
                this.setStatus(bicycle.bicycleNumber, false, 'Under Repair', {
                    issue: bicycle.issueDescription,
                    priority: bicycle.priority,
                    reportDate: bicycle.reportedDate
                });
            }
        });

        // Mark arranged bicycles
        AppState.arrangements.forEach(arr => {
            if ((arr.status === 'Ready' || arr.status === 'Issued') && arr.bicycleNumber) {
                this.setStatus(arr.bicycleNumber, false, 'Reserved', {
                    room: arr.roomNumber,
                    guest: arr.guestName,
                    arrival: arr.arrivalDate
                });
            }
        });

        // Update all dropdowns
        updateAllDropdowns();
    },

    setStatus(bicycleNumber, available, status, details = null) {
        const bicycle = this.inventory.get(bicycleNumber);
        if (bicycle) {
            bicycle.available = available;
            bicycle.status = status;
            bicycle.details = details;
            this.inventory.set(bicycleNumber, bicycle);
        }
    },

    getAvailable(type) {
        const available = [];
        this.inventory.forEach((value, number) => {
            if (value.type === type && value.available) {
                available.push({
                    number,
                    ...value
                });
            }
        });
        return available.sort((a, b) => a.number.localeCompare(b.number));
    },

    getBicyclesByType(type) {
        const bicycles = [];
        this.inventory.forEach((value, number) => {
            if (value.type === type) {
                bicycles.push({
                    number,
                    ...value
                });
            }
        });
        return bicycles.sort((a, b) => a.number.localeCompare(b.number));
    }
};

// Utility Functions
function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-GB', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    });
}

function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.style.backgroundColor = 
        type === 'success' ? '#4CAF50' : 
        type === 'error' ? '#f44336' : 
        type === 'warning' ? '#ff9800' : '#2196F3';
    
    notification.style.display = 'block';
    setTimeout(() => {
        notification.style.display = 'none';
    }, 3000);
}

// Tab Management
function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
    });
    
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
    });
    
    document.getElementById(tabName + 'Tab').style.display = 'block';
    document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
}

// Initialize Firebase Collections
async function initializeFirebaseCollections() {
    try {
        await Promise.all([
            db.collection('bicycleRecords').get(),
            db.collection('faultyBicycles').get(),
            db.collection('arrangements').get()
        ]);
        console.log('Firebase collections initialized');
        return true;
    } catch (error) {
        console.error('Error initializing Firebase collections:', error);
        showNotification('Database initialization failed', 'error');
        return false;
    }
}
</script>
```javascript
<script>
// Form Handling and Validation
function validateBicycleForm() {
    const issueDate = new Date(document.getElementById('issueDate').value);
    const departureDate = new Date(document.getElementById('departureDate').value);
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    if (issueDate < today) {
        showNotification('Issue date cannot be in the past', 'error');
        return false;
    }

    if (departureDate <= issueDate) {
        showNotification('Departure date must be after issue date', 'error');
        return false;
    }

    if (!document.getElementById('bicycleNumber').value) {
        showNotification('Please select a bicycle number', 'error');
        return false;
    }

    return true;
}

// Dropdown Management
function updateAllDropdowns() {
    updateBicycleTypeDropdowns();
    updateBicycleNumberDropdowns();
}

function updateBicycleTypeDropdowns() {
    const typeDropdowns = [
        document.getElementById('bicycleType'),
        document.getElementById('faultyBicycleType')
    ];

    typeDropdowns.forEach(dropdown => {
        if (!dropdown) return;
        
        dropdown.innerHTML = '<option value="">Select Type</option>';
        Object.entries(BicycleInventory.types).forEach(([type, config]) => {
            const available = BicycleInventory.getAvailable(type).length;
            const option = new Option(
                `${config.label} (${available} available)`,
                type
            );
            dropdown.add(option);
        });
    });
}

function updateBicycleNumberDropdowns() {
    const mainSelect = document.getElementById('bicycleNumber');
    const faultySelect = document.getElementById('faultyBicycleNumber');
    const type = document.getElementById('bicycleType').value;

    if (mainSelect) {
        mainSelect.innerHTML = '<option value="">Select Bicycle</option>';
        if (type) {
            BicycleInventory.getAvailable(type).forEach(bike => {
                mainSelect.add(new Option(bike.number, bike.number));
            });
        }
    }

    if (faultySelect) {
        faultySelect.innerHTML = '<option value="">Select Bicycle</option>';
        if (type) {
            BicycleInventory.getBicyclesByType(type).forEach(bike => {
                const option = new Option(bike.number, bike.number);
                if (!bike.available) {
                    option.disabled = true;
                    option.textContent += ` (${bike.status})`;
                }
                faultySelect.add(option);
            });
        }
    }
}

// Data Loading Functions
async function loadAllData() {
    try {
        showNotification('Loading data...', 'info');
        
        const [recordsSnapshot, faultySnapshot, arrangementsSnapshot] = await Promise.all([
            db.collection('bicycleRecords').orderBy('timestamp', 'desc').get(),
            db.collection('faultyBicycles').orderBy('timestamp', 'desc').get(),
            db.collection('arrangements').orderBy('arrivalDate').get()
        ]);

        AppState.records = recordsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        AppState.faultyBicycles = faultySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        AppState.arrangements = arrangementsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        BicycleInventory.updateStatus();
        
        displayRecords();
        displayFaultyBicycles();
        displayArrangements();
        displayTodayDepartures();

        showNotification('Data loaded successfully', 'success');
        return true;
    } catch (error) {
        console.error('Error loading data:', error);
        showNotification('Error loading data', 'error');
        return false;
    }
}

// Display Functions
function displayRecords(recordsToShow = AppState.records) {
    const table = document.getElementById('recordsTable').getElementsByTagName('tbody')[0];
    table.innerHTML = '';
    
    recordsToShow.forEach((record, index) => {
        const row = table.insertRow();
        const status = record.status.toLowerCase();
        
        row.innerHTML = `
            <td>${record.roomNumber}</td>
            <td>${record.guestName}</td>
            <td>${formatDate(record.issueDate)}</td>
            <td>${formatDate(record.departureDate)}</td>
            <td>${record.bicycleNumber}</td>
            <td><span class="badge badge-${status}">${record.status}</span></td>
            <td class="no-print">
                ${record.status !== 'Returned' ? `
                    <button class="btn btn-warning" onclick="editRecord(${index})">Edit</button>
                    <button class="btn btn-success" onclick="markAsReturned('${record.id}')">Return</button>
                    <button class="btn btn-danger" onclick="deleteRecord('${record.id}')">Delete</button>
                ` : ''}
            </td>
        `;
    });
}

function displayFaultyBicycles(bicyclesToShow = AppState.faultyBicycles) {
    const table = document.getElementById('faultyBicycleTable').getElementsByTagName('tbody')[0];
    table.innerHTML = '';

    bicyclesToShow.forEach((bicycle, index) => {
        const row = table.insertRow();
        row.classList.add(`priority-${bicycle.priority}`);
        
        row.innerHTML = `
            <td>${bicycle.bicycleNumber}</td>
            <td>
                <div>${bicycle.issueDescription}</div>
                ${bicycle.maintenanceNotes ? `
                    <small class="text-muted">${bicycle.maintenanceNotes}</small>
                ` : ''}
            </td>
            <td><span class="badge badge-${bicycle.priority}">${bicycle.priority.toUpperCase()}</span></td>
            <td><span class="badge badge-${bicycle.status.toLowerCase().replace(' ', '-')}">${bicycle.status}</span></td>
            <td>${formatDate(bicycle.reportedDate)}</td>
            <td>${bicycle.estimatedRepairTime} days</td>
            <td class="no-print">
                ${bicycle.status !== 'Fixed' ? `
                    <button class="btn btn-warning" onclick="editFaultyBicycle(${index})">Edit</button>
                    <button class="btn btn-success" onclick="markAsFixed('${bicycle.id}')">Mark Fixed</button>
                ` : ''}
                <button class="btn btn-primary" onclick="viewMaintenanceHistory('${bicycle.id}')">History</button>
            </td>
        `;
    });
}

function displayArrangements(arrangementsToShow = AppState.arrangements) {
    const table = document.getElementById('arrangementTable').getElementsByTagName('tbody')[0];
    table.innerHTML = '';

    const sortedArrangements = [...arrangementsToShow].sort((a, b) => 
        new Date(a.arrivalDate) - new Date(b.arrivalDate)
    );

    sortedArrangements.forEach((arrangement, index) => {
        const row = table.insertRow();
        const isToday = new Date(arrangement.arrivalDate).toDateString() === new Date().toDateString();
        
        if (isToday) {
            row.classList.add('priority-high');
        }

        const typeSelect = createBicycleTypeSelect(
            arrangement.bicycleType,
            arrangement.status === 'Issued'
        ).outerHTML;

        const numberSelect = createBicycleNumberSelect(
            arrangement.bicycleType,
            arrangement.bicycleNumber,
            arrangement.status === 'Issued'
        ).outerHTML;

        row.innerHTML = `
            <td>${arrangement.roomNumber}</td>
            <td>${arrangement.guestName}</td>
            <td>${formatDate(arrangement.arrivalDate)}</td>
            <td>${formatDate(arrangement.departureDate)}</td>
            <td>${typeSelect}</td>
            <td>${numberSelect}</td>
            <td><span class="badge badge-${arrangement.status.toLowerCase()}">${arrangement.status}</span></td>
            <td class="no-print">
                ${getArrangementActions(arrangement, index)}
            </td>
        `;

        // Add event listeners to dropdowns
        const typeSelectElement = row.querySelector('select:first-of-type');
        const numberSelectElement = row.querySelector('select:last-of-type');

        typeSelectElement?.addEventListener('change', e => 
            updateArrangementBicycleType(index, e.target.value)
        );
        numberSelectElement?.addEventListener('change', e => 
            updateArrangementBicycleNumber(index, e.target.value)
        );
    });
}

function displayTodayDepartures() {
    const today = new Date().toISOString().split('T')[0];
    const departingToday = AppState.records.filter(record => 
        record.departureDate === today && 
        record.status !== 'Returned'
    );

    const departuresDiv = document.getElementById('todayDepartures');
    const departuresList = document.getElementById('departuresList');

    if (departingToday.length === 0) {
        departuresDiv.style.display = 'none';
        return;
    }

    departuresDiv.style.display = 'block';
    departuresList.innerHTML = `
        <div class="departures-header">
            <h3>Priority Collections (${departingToday.length})</h3>
            <p>Today: ${formatDate(today)}</p>
        </div>
        ${departingToday.map(record => `
            <div class="departure-item priority-high">
                <div class="departure-info">
                    <strong>Room ${record.roomNumber}</strong>
                    <span class="guest-name">${record.guestName}</span>
                    <span class="bicycle-number">${record.bicycleNumber}</span>
                </div>
                <button class="btn btn-success" onclick="markAsReturned('${record.id}')">
                    Collect & Return
                </button>
            </div>
        `).join('')}
    `;
}
</script>
<script>
// PDF Processing Class
class ArrivalPDFProcessor {
    constructor() {
        this.processedData = [];
        this.errors = [];
    }

    async processPDF(file) {
        try {
            showNotification('Processing arrival information...', 'info');
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            
            this.processedData = [];
            
            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                const page = await pdf.getPage(pageNum);
                const textContent = await page.getTextContent();
                const text = textContent.items.map(item => item.str.trim()).join(' ');
                await this.extractArrivalData(text);
            }

            if (this.processedData.length === 0) {
                throw new Error('No valid arrival data found in PDF');
            }

            await this.generateExcel();
            await this.saveToDatabase();
            
            return {
                success: true,
                processed: this.processedData.length,
                errors: this.errors
            };
        } catch (error) {
            console.error('PDF processing error:', error);
            throw error;
        }
    }

    async extractArrivalData(text) {
        const roomPattern = /Rm No\.\s*(\d+)/g;
        const guestPattern = /Guest Name\s*([^\n]+?)(?=\s*(?:Last Visit|VIP|Adults|Children))/g;
        const arrivalPattern = /Arr Date\s*(\d{2}-\d{2}-\d{2})/g;
        const departurePattern = /Dep Date\s*(\d{2}-\d{2}-\d{2})/g;

        let matches;
        let currentEntry = {};

        // Extract room numbers
        while ((matches = roomPattern.exec(text)) !== null) {
            currentEntry = {
                roomNumber: matches[1].trim()
            };

            // Find corresponding guest name
            guestPattern.lastIndex = matches.index;
            const guestMatch = guestPattern.exec(text);
            if (guestMatch) {
                currentEntry.guestName = guestMatch[1].trim();
            }

            // Find arrival date
            arrivalPattern.lastIndex = matches.index;
            const arrivalMatch = arrivalPattern.exec(text);
            if (arrivalMatch) {
                currentEntry.arrivalDate = this.formatDate(arrivalMatch[1]);
            }

            // Find departure date
            departurePattern.lastIndex = matches.index;
            const departureMatch = departurePattern.exec(text);
            if (departureMatch) {
                currentEntry.departureDate = this.formatDate(departureMatch[1]);
            }

            if (this.validateEntry(currentEntry)) {
                this.processedData.push({
                    ...currentEntry,
                    status: 'Pending',
                    bicycleType: '',
                    bicycleNumber: ''
                });
            }
        }
    }

    validateEntry(entry) {
        if (!entry.roomNumber || !entry.guestName || !entry.arrivalDate || !entry.departureDate) {
            this.errors.push(`Incomplete data for room ${entry.roomNumber || 'unknown'}`);
            return false;
        }

        const arrival = new Date(entry.arrivalDate);
        const departure = new Date(entry.departureDate);

        if (isNaN(arrival.getTime()) || isNaN(departure.getTime())) {
            this.errors.push(`Invalid dates for room ${entry.roomNumber}`);
            return false;
        }

        if (departure <= arrival) {
            this.errors.push(`Invalid date range for room ${entry.roomNumber}`);
            return false;
        }

        return true;
    }

    formatDate(dateStr) {
        // Convert DD-MM-YY to YYYY-MM-DD
        const parts = dateStr.split('-');
        if (parts.length === 3) {
            const year = '20' + parts[2];
            return `${year}-${parts[1]}-${parts[0]}`;
        }
        return dateStr;
    }

    async generateExcel() {
        try {
            const ws = XLSX.utils.json_to_sheet(this.processedData.map(entry => ({
                'Room Number': entry.roomNumber,
                'Guest Name': entry.guestName,
                'Arrival Date': formatDate(entry.arrivalDate),
                'Departure Date': formatDate(entry.departureDate)
            })));

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Arrivals');

            const excelBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([excelBuffer], { 
                type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
            });

            saveAs(blob, `Arrivals_${new Date().toISOString().split('T')[0]}.xlsx`);
        } catch (error) {
            console.error('Excel generation error:', error);
            throw error;
        }
    }

    async saveToDatabase() {
        const batch = db.batch();
        
        this.processedData.forEach(entry => {
            const docRef = db.collection('arrangements').doc();
            batch.set(docRef, {
                ...entry,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        });

        await batch.commit();
    }
}

// Action Handlers
async function markAsReturned(id) {
    try {
        await db.collection('bicycleRecords').doc(id).update({
            status: 'Returned',
            returnDate: new Date().toISOString()
        });
        showNotification('Bicycle marked as returned');
    } catch (error) {
        console.error('Error marking as returned:', error);
        showNotification('Error marking bicycle as returned', 'error');
    }
}

async function markAsFixed(id) {
    try {
        const bicycle = AppState.faultyBicycles.find(b => b.id === id);
        const history = [...(bicycle.history || []), {
            date: new Date().toISOString(),
            action: 'Fixed',
            notes: 'Bicycle repaired and ready for use'
        }];

        await db.collection('faultyBicycles').doc(id).update({
            status: 'Fixed',
            fixedDate: new Date().toISOString(),
            history: history
        });
        showNotification('Bicycle marked as fixed');
    } catch (error) {
        console.error('Error marking as fixed:', error);
        showNotification('Error marking bicycle as fixed', 'error');
    }
}

async function deleteRecord(id) {
    if (!confirm('Are you sure you want to delete this record?')) return;
    
    try {
        await db.collection('bicycleRecords').doc(id).delete();
        showNotification('Record deleted successfully');
    } catch (error) {
        console.error('Error deleting record:', error);
        showNotification('Error deleting record', 'error');
    }
}

// Search and Filter Functions
function searchByBicycle() {
    const searchTerm = document.getElementById('bicycleSearch').value.toLowerCase();
    if (!searchTerm) {
        showNotification('Please enter a bicycle number', 'warning');
        return;
    }

    const filtered = AppState.records.filter(record => 
        record.bicycleNumber.toLowerCase().includes(searchTerm)
    );
    displayRecords(filtered);
}

function searchByRoom() {
    const searchTerm = document.getElementById('roomSearch').value.toLowerCase();
    if (!searchTerm) {
        showNotification('Please enter a room number', 'warning');
        return;
    }

    const filtered = AppState.records.filter(record => 
        record.roomNumber.toLowerCase().includes(searchTerm)
    );
    displayRecords(filtered);
}

function filterArrangements() {
    const date = document.getElementById('arrangementDate').value;
    if (!date) {
        displayArrangements();
        return;
    }

    const filtered = AppState.arrangements.filter(arr => arr.arrivalDate === date);
    displayArrangements(filtered);
}

// PDF Upload Handler
async function handlePDFUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    const processor = new ArrivalPDFProcessor();
    
    try {
        const result = await processor.processPDF(file);
        displayProcessingSummary(result);
        await loadAllData();
    } catch (error) {
        showNotification(`Error processing PDF: ${error.message}`, 'error');
    }
}

// Real-time Updates
function setupRealTimeListeners() {
    db.collection('bicycleRecords')
        .onSnapshot(snapshot => {
            AppState.records = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (AppState.initialized) {
                displayRecords();
                displayTodayDepartures();
                BicycleInventory.updateStatus();
            }
        });

    db.collection('faultyBicycles')
        .onSnapshot(snapshot => {
            AppState.faultyBicycles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (AppState.initialized) {
                displayFaultyBicycles();
                BicycleInventory.updateStatus();
            }
        });

    db.collection('arrangements')
        .onSnapshot(snapshot => {
            AppState.arrangements = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (AppState.initialized) {
                displayArrangements();
                BicycleInventory.updateStatus();
            }
        });
}

// System Initialization
document.addEventListener('DOMContentLoaded', async function() {
    try {
        showNotification('Initializing system...', 'info');
        
        // Initialize Firebase collections
        await initializeFirebaseCollections();
        
        // Initialize bicycle inventory
        BicycleInventory.initialize();
        
        // Set default dates
        document.getElementById('issueDate').valueAsDate = new Date();
        document.getElementById('arrangementDate').valueAsDate = new Date();
        
        // Load initial data
        await loadAllData();
        
        // Setup real-time listeners
        setupRealTimeListeners();
        
        // Add event listeners
        document.getElementById('bicycleType').addEventListener('change', updateBicycleNumberDropdowns);
        document.getElementById('faultyBicycleType').addEventListener('change', updateBicycleNumberDropdowns);
        
        AppState.initialized = true;
        showNotification('System ready', 'success');
    } catch (error) {
        console.error('Initialization error:', error);
        showNotification('Error initializing system', 'error');
    }
});
</script>
</body>
</html>